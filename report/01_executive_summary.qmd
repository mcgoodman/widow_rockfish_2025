# Executive Summary

<!-- 
Note r4ss::table_exec_summary() will create the required tables. 
It currently makes them as csv files. 
sa4ss::es_table_tex will convert them to text files formatted as LaTeX tables if you prefer.
-->

## Stock{-}

This is an update assessment of widow rockfish (*Sebastes entomelas*) that reside in the waters off California, Oregon, and Washington from the U.S.-Canada border in the north to the U.S.-Mexico border in the south. The most recent benchmark was conducted in 2015 [@hicks_status_2015] and first updated in 2019 [@adams_status_2019]. This assessment represents the second update assessment of this stock. Widow rockfish inhabit water depths of 25–370 m from northern Baja California, Mexico to Southeastern Alaska. Although catches north of the U.S.-Canada border and south of the U.S.-Mexico border were not included in this assessment, it is not certain if those populations contribute to the biomass of widow rockfish off of the U.S. West Coast, possibly through adult migration and/or larval dispersion. Following the 2015 benchmark assessment [@hicks_status_2015], this update assessment is based on a single costwide area model.

{{< pagebreak >}} 

## Catches{-}

Historically, fisheries have caught widow rockfish since the turn of the 20th century. Landings in the trawl fishery are estimated to have increased into the 1940s and remained relatively constant and small (below 1,000 mt per year) throughout the 1950s and into the 1960s before the foreign trawl fleet increased catches into the 1970s, with a peak at almost 5,000 mt in 1967. In the late 1970s a midwater trawl fishery developed for widow rockfish and catches increased rapidly with the discovery of large aggregations that form at night. 

Total landings of widow rockfish peaked in the early 1980s, increasing from approximately 1,000 metric tons (mt) in 1978 to over 25,000 mt in 1981. The large landings in the early 1980s were curtailed with trip limits beginning in 1982, which resulted in a decline in landings throughout the 1980s and 1990s following sequential reductions in the trip limits. From 2000 to 2003, landings of widow rockfish dropped from over 4,000 mt to about 40 mt and remained low through 2016. Catches increased rapidly following the quota share reallocation in 2017, and have been near or above 10,000 mt in all years between 2018-2024. Midwater trawl gears in groundfish and Pacific Whiting (hake) fisheries account for the majority of the recent catch. 

Widow rockfish are a desirable market species and it is believed that discarding was low historically. However, management restrictions (e.g., trip limits) resulted in a substantial amount of discarding beginning in the early 1980s. Trawl rationalization was introduced in 2011. Between 2011 and 2024 very little discarding of widow rockfish is estimated to have occurred. Recent discards in the model informed by data from the West Coast Observer Program (WCGOP), and total catches (discards plus landings) are reported in addition to landings.

{{< pagebreak >}} 

```{r}
#| label: tbl-a
#| echo: false
#| warning: false
#| tbl-cap: "Recent landings for the bottom trawl, midwater trawl, at-sea hake, net, and hook-and-line fisheries and the total landings across fisheries and the total mortality (discards + landings) (mt). 100% mortality is assumed for discards and catch sources are described below."

library("flextable")
library("dplyr")
library("officer")
library("here")

exec_tab_style <- function(ft) {
  ft %>% 
  font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 9, part = "all") %>% 
  bold(part="header") %>%
  hline(part="header") %>%
  hline_top(part="header") %>% hline_bottom() %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body") %>%
  width(width = 7/length(ft))
}

# Function to read in lenght-1 .Rdata / .rda with name of choice
read_rdata <- function(path) {load(path); get(ls()[ls() != "path"])}

#Old table 12
table_A <- read_rdata(here("report", "tables", "exec_summ_tables", "catches_es.rda"))

table_A <- table_A$table |> mutate(across(is.numeric, round, digits = 1))

table_A <- round(table_A, 2) # manually round bc flex table isn't working well

# # Build header map (multi-row header)
# header_df <- data.frame(
#   keys = names(table_A),
#   line1 = c("Year", "Bottom Trawl","Midwater Trawl","At-Sea Hake", "Net","Hook-and-line", "Total Landings","Total Mortality"),
#   stringsAsFactors = FALSE
# )

# Create flextable
flextable(table_A, col_keys = names(table_A)) %>%
  # set_header_df(mapping = header_df, key = "keys") %>%
  set_header_labels(names = names(table_A), values = c("Year", "Bottom Trawl","Midwater Trawl","At-Sea Hake", "Net","Hook-and-line", "Total Landings","Total Mortality")) %>% 
  # merge_h(part = "header") %>%
  # merge_v(part = "header") %>%
  # border(part = "all") %>%
  # align(align = "center", part = "all") %>%
  # font(fontname = "Times New Roman", part = "all") %>%
  # bold(part = "header")%>%
  colformat_num(j = 1, big.mark = "", digits = 0)%>%
  fontsize(size = 9, part = "all") %>%
  set_table_properties(layout = "autofit") %>% exec_tab_style # %>%
  # colformat_num(j = 2:ncol(table_A), big.mark = "", digits = 2) 


```


```{r}
#| label: fig-a
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Landings of widow rockfish from 1916 to 2024 for bottom trawl, midwater trawl, net, and hook- and-line fisheries, and catches of widow rockfish for the foreign (1966–1976) and Pacific Whiting (hake) fisheries (green)."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/catch5_total_catch_(including_discards)_stacked.png")
)

```

## Data and Assessment{-}

```{r}
#| include: false

model_path <- here::here("models", "2025 base model")
report <- r4ss::SS_output(dir = model_path, verbose = FALSE, printstats = FALSE)

```


This assessment uses the length- and age-structured modeling software Stock Synthesis (version 3.30.23.1), while the update assessment in 2019 used 3.30.13. The coastwide population was modeled assuming separate growth and mortality parameters for each sex (a two-sex model) from 1916 to 2024, and forecasted beyond 2024.

Five fishing fleets were specified within the model: 1) a shorebased bottom trawl fleet with coastwide catches from 1916–2024, 2) a shorebased midwater trawl fleet with coastwide catches from 1979–2024, 3) a mostly midwater trawl fleet that targets Pacific Hake/Whiting (*Merluccius productus*) and includes a foreign and at-sea fleet with catches from 1975–2024, a domestic shorebased fleet that targeted Pacific Hake with catches from 1991–2024, and foreign vessels that targeted Pacific Hake and rockfish between 1966–1976, 4) a net fishery consisting of catches mostly from California from 1981–2024, and 5) a hook-and-line fishery (predominantly longline) with coastwide catches from 1916–2024. Landings are summarized in @fig-a. 

Data from three fishery-independent surveys were also included in the model: 1) the National Marine Fisheries Service (NMFS) Southwest Fisheries Science Center (SWFSC) and Northwest Fisheries Science Center (NWFSC)/Pacific Whiting Conservation Cooperative (PWCC) Midwater Trawl Survey that provides pre-recruit indices of abundance from 2004-2024, 2) the NMFS Triennial Shelf Survey which was conducted from 1977–2004 in depths less than 500 meters, and 3) the NWFSC West Coast Groundfish Bottom Trawl Survey (WCGBTS) which has been surveying the entire U.S. West Coast in depths between 55 and 1,280 meters since 2003. Three historical fishery-dependent CPUE indices were included as in the 2015 and 2019 assessments, derived from 1) Oregon bottom trawl (1984-1999), 2) Pacific Whiting at-sea foreign (1977-1988), and 3) Pacific whiting at-sea domestic fleets (1983-1998).

The data used in the assessment model consisted of survey abundance indices, length compositions, discard data, and age compositions. Model-based biomass indices and length compositions were determined for the NMFS Triennial Shelf and NWFSC West Coast Groundfish Bottom Trawl Surveys. Length and age compositions were also available from the five fisheries. Age data for all years of the WCGBTS were input as age-at-length compositions. Discard data for the bottom trawl, midwater trawl, and hook-and-line fisheries were available in various years in the form of discarded biomass and length compositions.

The base model estimated parameters for length-based selectivity for all fleets and surveys, retention curves based on length for the bottom trawl and midwater trawl fleets, a length-at- age relationship, natural mortality for males and females assuming lognormal priors, and recruitment deviations starting in 1900. A Beverton-Holt stock-recruitment function was used to model productivity and the steepness parameter was fixed at `r report$parameters["SR_BH_steep","Value"]` based on a steepness meta-analysis for west coast rockfishes. 

Estimation uncertainty in the base model was determined using approximate asymptotic 95% confidence intervals based on maximum likelihood theory. Natural mortality and steepness are major sources of uncertainty. We used high and low combinations of these parameters to define a range of states of nature, with results presented in a decision table. 

<!-- The major axis of uncertainty was determined to define a range of states of nature and results are presented in a decision table.  -->

<!-- Although there are many types of data available for widow rockfish since the late 1970s, which were used in this assessment, there is little information about steepness and natural mortality, and recent recruitment (although likelihood profiles in this update assessment suggest additional data has contributed higher certainty in natural mortality estimates). Estimates of steepness are uncertain partly because of variable recruitment. Uncertainty in natural mortality is common in many fish stock assessments even when length and age data are available. Finally, there is little information about the strength of recent recruitment because the young fish are seen with a lower probability in the fisheries and surveys. These uncertainties were characterized as best as possible in the predictions and projections from this assessment. -->

## Stock biomass and dynamics{-}

```{r}
#| include: false

model_path <- here::here("models", "2025 base model")
report <- r4ss::SS_output(dir = model_path, verbose = FALSE, printstats = FALSE)

catch_sum <- aggregate(report$catch$Exp, by = list(Yr = report$catch$Yr), sum)

table_b <- read_rdata(here::here("report", "tables", "exec_summ_tables", "ssb_es.rda"))$table
names(table_b) <- c("Year", "SSB", "SSB_Lwr", "SSB_Upr", "Bratio", "Bratio_Lwr", "Bratio_Upr")

require("dplyr")

SSB <- report$derived_quants[report$derived_quants$Label %in% paste0("SSB_", 1916:2036),]
SSB$Year <- as.integer(gsub("SSB_", "", SSB$Label))

Bratio <- report$derived_quants[report$derived_quants$Label %in% paste0("Bratio_", 1916:2036),]
Bratio$Year <- as.integer(gsub("Bratio_", "", Bratio$Label))

# SSB <- SSB |>
#   select(Year, SSB = Value, SD = StdDev) |>
#   mutate(
#     mu_log = log(SSB) - 0.5 * log((SD^2)/(SSB^2) + 1),
#     sigma_log = sqrt(log(1 + ((SD^2) / (SSB^2)))),
#     lower = qlnorm(0.025, mu_log, sigma_log),
#     upper = qlnorm(0.975, mu_log, sigma_log)
#   )

```


The predicted spawning biomass from the base model generally showed a slight decline over the time series until 1966 when the foreign fleet began. A short, but sharp decline occurred, followed by a steep increase (peaking in 1979) due to strong recruitment. The spawning biomass declined rapidly with the developing domestic midwater fishery in the late 1970s and early 1980s. The stock continued to decline until 2000. A combination of strong recruitment and low catches resulted in a steady increase in spawning biomass through 2016. A target fishery for widow rockfish was reestablished in 2017. The stock exhibits a decline in most recent years with the increased catches since 2017, and lack of evidence for recent large recruitment events.

The 2024 spawning stock biomass (SSB) relative to unfished equilibrium spawning biomass is at `r round(table_b$Bratio[table_b$Year == 2024] * 100)`, above the target of 40%. 

Approximate confidence intervals based on the asymptotic variance estimates show that the uncertainty in the estimated spawning biomass is high, especially in the early years. Spawning biomass is estimated to be at `r format(SSB$Value[SSB$Year == 2024], big.mark = ",", digits = 1)` mt in 2024, with an asymptotic 95% confidence interval of `r paste(format(table_b[table_b$Year == 2024, c("SSB_Lwr", "SSB_Upr")], big.mark = ",", digits = 1), collapse = " - ")`. The corresponding confidence interval for the relative SSB is `r paste(paste0(round(table_b[table_b$Year == 2024, c("Bratio_Lwr", "Bratio_Upr")] * 100, 1), "%"), collapse = " - ")`, for which the lower bound is below the management target of 40%.


```{r}
#| label: fig-b
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Estimated female spawning biomass time-series from the base model (solid line) with an approximate asymptotic 95% confidence interval (dashed lines)."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/ts7_Spawning_output_with_95_intervals.png")
)

```

```{r}
#| label: fig-c
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Estimated relative spawning biomass (depletion) with approximate 95% asymptotic confidence intervals (dashed lines) for the base case assessment model."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/ts9_Relative_spawning_biomass_intervals.png")
)

```
{{< pagebreak >}} 
```{r}
#| label: tbl-b
#| echo: false
#| warning: false
#| tbl-cap: "Recent trend in estimated female spawning biomass (mt) and relative spawning biomass (depletion)."

#Old table 12
table_B <- read_rdata(here::here("report", "tables", "exec_summ_tables", "ssb_es.rda"))$table

table_B <- table_B |> 
  mutate(
    SSB = format(round(`Spawning Biomass (mt)`), big.mark = ","),
    SSB_lower = format(round(`Lower Interval (mt)`, 0), big.mark = ","), 
    SSB_upper = format(round(`Upper Interval (mt)`, 0), big.mark = ","),
    SSB_CI = paste0(SSB_lower, " - ", SSB_upper), 
    Bratio_CI = paste0(round(`Lower Interval`, 3),  " - ", round(`Upper Interval`, 3))
  ) |>
  dplyr::select(Year, SSB, SSB_CI, `Fraction Unfished`, Bratio_CI)

colnames <- c(
  "Year", "Spawning Biomass", "95% Confidence Interval", 
  "Estimated Depletion (%)", "95% Confidence Interval"
)

# Create flextable
flextable(table_B, col_keys = names(table_B)) |> 
  set_header_labels(names = names(table_B), values = colnames) |> 
  set_table_properties(layout = "autofit") %>% exec_tab_style

```

{{< pagebreak >}} 

## Recruitment{-}

Recruitment deviations were estimated for the entire time series modeled. There is little information regarding recruitment prior to 1965, and the uncertainty in these estimates is expressed in the model. 

There are several very large, but uncertain, estimates of recruitment (in descending order of magnitude) in 1970, 2008, 2016,  and 1971. Other large recruitment events (in descending order of magnitude) occurred in 1978, 1981, 2010, and 1991.

The five lowest recruitments (in ascending order) occurred in 2012, 2019, 2020, 2011, and 1976. Estimates of recruitment appear to be episodic and characterized by periods of low recruitment.

```{r}
#| label: fig-d
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Time-series of estimated recruitments (medians as open circles) for the base case model with approximate asymptotic 95% confidence interval (vertical bars). Estimated mean unfished equilibrium recruitment (R0) is shown as the closed circle with a 95% confidence interval at the beginning of the time series."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/ts11_Age-0_recruits_(1000s)_with_95_asymptotic_intervals.png")
)

```


```{r}
#| label: tbl-c
#| echo: false
#| warning: false
#| tbl-cap: "Recent estimated trend in widow rockfish recruitment with approximate 95% confidence intervals determined from the base model."
#| out.width: "90%"
#| fig-align: "center"

table_c <- read_rdata(here::here("report", "tables", "exec_summ_tables", "recr_es.rda"))$table

table_c <- table_c |> 
  mutate(
    recr = format(round(`Recruitment (1,000s)`), big.mark = ","),
    recr_lower = format(round(`Lower Interval (1,000s)`, 0), big.mark = ","), 
    recr_upper = format(round(`Upper Interval (1,000s)`, 0), big.mark = ","),
    recr_CI = paste0(recr_lower, " - ", recr_upper), 
    recdev_CI = paste0(round(`Lower Interval`, 3),  ", ", round(`Upper Interval`, 3))
  ) |>
  dplyr::select(Year, recr, recr_CI, `Recruitment Deviations`, recdev_CI)

colnames <- c(
  "Year", "Estimated recruitment (number in thousands)", "95% Confidence Interval", 
  "Recruitment \nDeviations", "95% Confidence Interval"
)

# Create flextable
flextable(table_c, col_keys = names(table_c)) |> 
  set_header_labels(names = names(table_C), values = colnames) %>%
  colformat_num(j=3, big.mark = ",")%>%
  exec_tab_style

```
{{< pagebreak >}} 

## Exploitation status{-}

The spawning biomass of widow rockfish reached a low in 2001 before increasing due to low catch levels. 

The lower bound of the 95% confidence interval of the estimated depletion dipped below the overfished threshold (25% minimum stock size threshold) in the very late 1990s and early 2000s. After recovering after 2016, the lower bound of the 95% confidence interval dipped below the 40% management target in 2024 but remains above the overfished threshold. The current depletion point estimate is greater than the spawning biomass target.

```{r}
#| label: tbl-d
#| echo: false
#| warning: false
#| tbl-cap: "Recent trend in spawning potential ratio and summary exploitation rate. Harvest rate is defined as catch divided by age 4+ biomass."

table_d <- read_rdata(here("report", "tables", "exec_summ_tables", "spr_es.rda"))$table

table_d <- table_d |> 
  mutate(
    across(is.numeric, \(x) round(x, 3)),
    SPR_CI = paste0(`Lower Interval (SPR)`, " - ", `Upper Interval (SPR)`), 
    rate_CI = paste0(`Lower Interval (Rate)`,  ", ", `Upper Interval (Rate)`)
  ) |>
  dplyr::select(Year, `(1-SPR)/(1-SPR 50%)`, SPR_CI, `Exploitation Rate`, rate_CI)

colnames <- c(
  "Year", "Estimated \n(1-SPR)/(1-SPR50%)", "~95% Confidence Interval", 
  "Harvest rate \n(proportion)", "~95% Confidence Interval"
)

# Create flextable
flextable(table_d, col_keys = names(table_d)) %>%
  set_header_labels(names = names(table_C), values = colnames) %>%
  exec_tab_style

```

{{< pagebreak >}} 

```{r}
#| label: fig-e
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Time-series of estimated summary harvest rate (catch divided by age 4+ biomass) for the base case model (round points) with approximate 95% asymptotic confidence intervals (gray lines)."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/ts_summaryF.png")
)

```

```{r}
#| label: fig-f
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Trend in estimated fishing intensity (relative to the SPR management target) through 2024 with 95% asymptotic confidence intervals. One minus SPR is used so that higher exploitation rates occur on the upper portion of the y-axis. The relative management target is plotted as a horizontal line and values above this reflect harvests in excess of the overfishing proxy based on SPR50%."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/SPR3_ratiointerval.png")
)

```

```{r}
#| label: fig-g
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Phase plot of estimated relative fishing intensity relative biomass for the base case model. The relative (1- SPR) is (1-SPR) divided by 0.5 (one minus the SPR target). Lines through the final point (2024) show 95% intervals based on the asymptotic uncertainty for each dimension. The shaded ellipse is a 95% region which accounts for the estimated correlation between the two quantities."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/SPR4_phase.png")
)

```
## Ecosystem considerations{-}

Rockfish (Sebastes spp.) are an important component of the California Current ecosystem along the U.S. West Coast, comprising more than sixty-five species filling various niches in both soft and hard bottom habitats from the nearshore to the continental slope, as well as near bottom and pelagic zones. Widow rockfish frequently aggregate in the pelagic zone. 

Recruitment is one mechanism by which the ecosystem may directly impact the population dynamics of widow rockfish. The specific pathways through which environmental conditions exert influence on widow rockfish dynamics are unclear; however, changes in water temperature and currents, distribution of prey and predators, and the amount and timing of upwelling are all possible linkages. Changes in the environment may also result in changes in age-at-maturity, fecundity, growth, and survival which can affect how the status of the stock and its susceptibility to fishing are determined. Unfortunately, there are few data available for widow rockfish that provide insights into these effects. 

Fishing has effects on both the age structure of a population as well as the target species habitat.  Fishing often targets larger, older fish, and years of fishing mortality results in a truncated age-structure when compared to unfished conditions. Rockfish are often associated with habitats containing living structures such as sponges and corals, and fishing may alter that habitat to a less desirable state. This assessment provides insight on the effects of fishing on age structure, and recent studies on essential fish habitat are beginning to characterize important locations for rockfish throughout their life history; however there is little current information available to evaluate the specific effects of fishing on the ecosystem issues specific to widow rockfish.

## Reference points{-}

```{r}
#| include: false

table_e <- read_rdata(here::here("report", "tables", "exec_summ_tables", "reference_points.rda"))$table

ref_pts <- table_e
colnames(ref_pts) <- c("Label", "Est", "Lwr", "Upr")

ref_pts <- setNames(
  lapply(seq_len(nrow(ref_pts)), function(i) {
    vals <- ref_pts[i, c("Est", "Lwr", "Upr")]
    vals <- format(round(as.numeric(vals)), big.mark = ",", scientific = FALSE)
    setNames(as.list(vals), c("Est", "Lwr", "Upr"))
  }),
  nm = gsub("\\\\%", "%", ref_pts$Label)
)
```

Reference points were calculated using the estimated selectivities and average catch distribution among fleets in the most recent five years of the model (2019-2024). Total yields (landings plus discards) were `r ref_pts[["Yield with SPR50 at SB SPR (mt)"]]$Est` mt when using an SPR50% reference harvest rate and with a 95% confidence interval of `r ref_pts[["Yield with SPR50 at SB SPR (mt)"]]$Lwr` to `r ref_pts[["Yield with SPR50 at SB SPR (mt)"]]$Upr` mt. The spawning biomass equivalent to 40% of the unfished spawning output (SB40%) was `r ref_pts[["Proxy Spawning Biomass (mt) SB40%"]]$Est` mt. Catches between the late 1990's and 2016 were well below the point estimate of potential long-term yields calculated using an SPR50% reference point, and the population is estimated to have increased continuously throughout that time period. However, catches from 2017 through 2024 were above the point estimate of potential long-term yields using an SPR50% reference point, exceeding the upper bound of the confidence interval in all years since 2018, and exceeding the point estimate by on average `r round(100 * (mean(catch_sum$x[catch_sum$Yr >= 2018]/ ref_pts$Est[ref_pts$Label == "Yield with SPR50 at SB SPR (mt)"]) - 1))`%.

The predicted spawning biomass from the base model generally showed a slight decline until the late 1970s, followed by steep increase above unfished equilibrium biomass and reaching a peak in `r report$timeseries$Yr[which.max(report$timeseries$SpawnBio)]`. This was followed by a steep decrease up to the mid-1980s, and then a more gradual decease through 2000 (@fig-c). Between 2001 and 2016, the spawning biomass increased continuously due to small catches, and several years of high recruitment (though with lower than average recruitment in other recent years). The spawning biomass relative to unfished equilibrium spawning biomass climbed above the target of 40% of unfished spawning biomass in the early 2000's. It is estimated to still be above the target, though the lower bound of the 95% confidence interval lies between the target and minimum stock size threshold (@fig-c). The fishing intensity (relative 1-SPR) exceeded the current estimates of the harvest rate limit (SPR50%) throughout the 1980s and early 1990s, and has again since 2018 (@fig-e). Exploitation rates on widow rockfish between 2001 and 2016 were predicted to be far below target levels. In recent years, the stock has experienced exploitation rates that have been above the target level while the biomass level has remained above the target level (@fig-g).

The equilibrium yield plot is shown in @fig-h, based on a steepness value fixed at `r report$parameters["SR_BH_steep","Value"]`. The predicted maximum sustainable yield under the assumptions of this assessment occurs near 25% of equilibrium unfished spawning biomass.

```{r}
#| label: tbl-e
#| echo: false
#| warning: false
#| tbl-cap: "Summary of reference points and management quantities for the base case model."

table_e <- table_e |> mutate(across(is.numeric, round, digits = 2))


flextable(table_e) %>%
  merge_h(part = "header") %>%
  merge_v(part = "header") %>%
  border(part = "all") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", j = 1) %>%
  font(fontname = "Times New Roman", part = "all") %>%
  bold(part = "header")%>%
  bold(i = c(6,11,16)  ,part="body")%>%
  colformat_num( digits = 2)%>%
  fontsize(size = 9, part = "all")%>%
  set_table_properties(layout = "autofit")

```

{{< pagebreak >}} 

## Management performance{-}


Exploitation rates on widow rockfish exceeded MSY proxy target harvest rates during the 1980s and 1990s and spawning biomass is predicted to have fallen below the proxy management target of 40%. Exploitation rates decreased in the late 1990s due to management restrictions, and have increased in recent years. Predicted catches in the last decade have not exceeded the annual catch limit (ACL) set by management.

```{r}
#| label: tbl-f
#| echo: false
#| warning: false
#| tbl-cap: "Recent trend in total catch and commercial landings (mt) relative to the management guidelines. Estimated total catch reflects the commercial landings plus the model estimated dead discarded biomass."

table_f <- read_rdata(here("report", "tables", "exec_summ_tables", "recent_management.rda"))$table

#colnames <- c("Year", "OFL (mt) (termed ABC prior to 2011)", "ABC (mt)", "ACL (mt)", "Estimated Total Catch (mt)", "Estimated Total Mortality (mt)")

# Create flextable
flextable(table_f) |> 
  colformat_num(j = 1, big.mark = "", digits = 0) %>%
  exec_tab_style

```

## Harvest projections and decision table{-}

```{r}
#| include: false

##dec table params
dec_table_pars <- report$parameters|> #make sure to ppull from report, not input file so est values are used
  mutate(
         value = Value,
         sd = if_else(is.na(Parm_StDev),Pr_SD,Parm_StDev))|> #If est par, use param sd, otherwise use prior sd
  filter(Num %in% c(1,13,24))|> #natM Female, natM male, steepness
  select(value,sd)|>
  mutate(
    q125 = round(qnorm(0.125,mean = value,sd = sd),3), #apply the quantiles
    q875 = round(qnorm(0.875,mean = value,sd = sd),3),
    phase = -1,
    name = c("NatM_p_1_Fem_GP_1", #name the parms - easier to do manually as report and r4ss::read() have different parameter names
             "NatM_p_1_Mal_GP_1",
             "SR_BH_steep") 
  )

#dec tables stuff
dec_table_pars["NatM_uniform_Fem_GP_1","q125"]
colnames(dec_table_pars)

dec_table_res <- read.csv(here("data_derived", "decision_table", "dec_table_formatted.csv"))

##gmt stuff
gmt_catch <- data.frame(read.csv(here("data_provided", "gmt_forecast_catch", "GMT_forecast_catch.csv"))|>
  group_by(year)|>
  summarise(total_catch = sum(catch_mt)))

dec_table_summ <- list(
  "p45_2027" = dec_table_res|>filter(scenario == "P*0.45" & yr == 2027)|>pull(catch),
  "p45_2036" = dec_table_res|>filter(scenario == "P*0.45" & yr == 2036)|>pull(catch),
  "p25_2027" = dec_table_res|>filter(scenario == "P*0.25" & yr == 2027)|>pull(catch),
  "p25_2036" = dec_table_res|>filter(scenario == "P*0.25" & yr == 2036)|>pull(catch)
)
```


Two categories of parameters that greatly contributed to uncertainty in the results were natural mortality (an important estimated parameter) and steepness (not estimated in the model). A combination of these two factors was used as the axis of uncertainty to define low and high states of nature. This differed from the 2019 assessment which included a third factor, 2013 recruitment strength. The 12.5% and 87.5% quantiles for female and male natural mortality (independently) were chosen as low and high values (`r dec_table_pars["NatM_uniform_Fem_GP_1","q125"]` yr^-1^ and `r dec_table_pars["NatM_uniform_Fem_GP_1","q875"]` yr^-1^ for females; `r dec_table_pars["NatM_uniform_Mal_GP_1","q125"]` yr^-1^ and `r dec_table_pars["NatM_uniform_Mal_GP_1","q875"]` yr^-1^ for males). Steepness is probably the most important factor since it was fixed in the base model and is not incorporated in the estimation uncertainty. The 12.5% and 87.5% quantiles from the steepness prior (without widow rockfish data) were used to define the low and high values of steepness (`r dec_table_pars["SR_BH_steep","q125"]` and `r dec_table_pars["SR_BH_steep","q875"]`). The low combination of these two factors defined the low state of nature and the high combination of these two factors defined the high state of nature. The predictions of spawning biomass in 2025 from the low and high states of nature are close to the 12.5% and 87.5% lognormal quantiles from the base model.

This assessment synthesizes many sources of data and estimates recruitment variability, thus it is classified as a Category 1 stock assessment. Therefore, the sigma to determine the catch reduction to account for scientific uncertainty is 0.50.

A twelve year projection of the base model with two catch streams based on ACL adjustments of 0.45 P* and 0.25 P* were conducted (@tbl-h).

Projections with catches based on the predicted annual catch limit (ACL) using the SPR rate of 50%, the 40:10 control rule, and a 0.45 P* adjustment using a sigma of 0.50 from 2027 onward suggest that the spawning biomass will decrease over the projection period for all states of nature (@tbl-h). Predicted ACL catches range from `r format(dec_table_summ$p45_2027, big.mark = ",", digits = 1)` mt in 2027 to `r format(dec_table_summ$p45_2036, big.mark = ",", digits = 1)` mt in 2036. 

Projections with catches based on the predicted annual catch limit (ACL) using the SPR rate of 50%, the 40:10 control rule, and a 0.25 P* adjustment using a sigma of 0.50 from 2027 onward suggest that the spawning biomass will decrease over the projection period for all states of nature. Predicted ACL catches range from `r format(dec_table_summ$p25_2027, big.mark = ",", digits = 1)` mt in 2027 to `r format(dec_table_summ$p25_2036, big.mark = ",", digits = 1)` mt in 2036. 


```{r}
#| label: tbl-g
#| echo: false
#| warning: false
#| tbl-cap: "Projection of potential OFL, landings, and catch, summary biomass (age-4 and older), spawning biomass, and depletion for the base case model projected with total catch equal to the predicted ABC. The predicted OFL is the calculated total catch determined by FSPR=50%."

table_g <- read_rdata(here::here("report", "tables", "exec_summ_tables", "projections.rda"))$table
table_g <- round(signif(table_g, 5), 3)
table_g[is.na(table_g)] <- "-"
flextable(table_g) %>%
  colformat_num(j = 1, big.mark = "", digits = 0) %>%
  set_table_properties(layout = "autofit") %>% 
  exec_tab_style() %>% 
  fit_to_width(max_width = 7.5)

```

{{< pagebreak >}} 

```{r}
#| label: tbl-h
#| echo: false
#| warning: false
#| tbl-cap: "Summary table of 12-year projections beginning in 2027 for alternate states of nature based on the axis of uncertainty (a combination of M, h). Columns range over low, mid, and high state of nature, and rows range over different assumptions of total catch levels (discards + retained). Catches in 2025 and 2026 are allocated using the percentage of landings for each fleet in 2019-2024."

table_h <- read.csv(here("data_derived", "decision_table", "dec_table_formatted.csv"))

# table_h <- table_h[,2:6]
# break up management & state of nature
# table_h$management_choice <- substr(table_h$name, start = 1, stop = 2)
table_h$scenario <- plyr::revalue(table_h$scenario,
                                  c("Constant catch" = "Constant catch (9,000 K)",
                                    "P*0.25" = "ACLp*=0.25, sigma=0.50",
                                    "P*0.45" = "ACLp*=0.45, sigma=0.50"))
# table_h$stnat <- substr(table_h$name, start = 4, stop = 7)

# pivot
# table_h |>
#   tidyr::pivot_wider(names_from = stnat, values_from = c(SpawnBio, dep), id_cols=-name) |>
#   # getting format closer...
#   dplyr::select(c(4, 1, 3, 2, 5, 8, 6, 9, 7, 10)) ->
#   # reordering for ease
#   # note this only works if OFL included, otherwise need to subtract 1 from col number
#   table_h_reorg

# colnames(table_h_reorg) <- c("Management decision", "Year", "OFL", "catch (mt)",
#                              "Spawning biomass (mt)", "Depletion (%)",
#                              "Spawning biomass (mt)", "Depletion (%)",
#                              "Spawning biomass (mt)", "Depletion (%)")

# flextable(table_h) |>
#   set_header_labels(values = c(scenario = "Management decision",
#                                yr = "Year",
#                                # OFL = "OFL",
#                                catch = "catch (mt)",
#                                SpawnBio_low = "Spawning biomass (mt)",
#                                dep_low = "Depletion (%)",
#                                SpawnBio_base = "Spawning biomass (mt)",
#                                dep_base = "Depletion (%)",
#                                SpawnBio_high = "Spawning biomass (mt)",
#                                dep_high = "Depletion (%)")
#                     ) |>
#   add_header_row(values = c("", "Low", "Base", "High"), colwidths = c(3, 2, 2, 2)) |>
#   add_header_row(values = c("", "State of nature"), colwidths = c(3, 6)) |>
#   align(align = "center", part = "all") |>
#   font(fontname = "Times New Roman", part = "all") |>
#   fontsize(size = 9, part ="all") |>
#   bold(part = "header", i = 1:2) |>
#   bold(part = "header", i = 3, j = 1) |>
#   colformat_num(j = 2, big.mark = "", digits = 0) |>
#   border_inner(part="header") |> border_outer() |> # header and outside border
#   vline(j = c(1, 3, 5, 7)) |> hline(i = 10) |> hline(i = 20) |>
#   merge_at(i = c(1:10), j = 1) |> merge_at(i = c(11:20), j = 1) |> merge_at(i = c(21:30), j = 1) |>
#   # set_table_properties(layout = "autofit", align = "center") |>
#   width(width = 0.6, j = 2:(dim(table_h)[2]-1)) |>
#   width(width = 0.9, j = 1)

table_h <- table_h|>filter(scenario != "Constant catch (9,000 K)")

flextable(table_h) |>
  set_header_labels(values = c(scenario = "Management decision",
                               yr = "Year",
                               # OFL = "OFL",
                               catch = "catch (mt)",
                               SpawnBio_low = "Spawning biomass (mt)",
                               dep_low = "Depletion (%)",
                               SpawnBio_base = "Spawning biomass (mt)",
                               dep_base = "Depletion (%)",
                               SpawnBio_high = "Spawning biomass (mt)",
                               dep_high = "Depletion (%)")
                    ) |>
  add_header_row(values = c("", "Low", "Base", "High"), colwidths = c(3, 2, 2, 2)) |>
  add_header_row(values = c("", "State of nature"), colwidths = c(3, 6)) |>
  align(align = "center", part = "all") |>
  font(fontname = "Times New Roman", part = "all") |>
  fontsize(size = 9, part ="all") |>
  bold(part = "header", i = 1:2) |>
  bold(part = "header", i = 3, j = 1) |>
  colformat_num(j = 2, big.mark = "", digits = 0) |>
  border_inner(part="header") |> border_outer() |> # header and outside border
  vline(j = c(1, 3, 5, 7)) |> hline(i = 10) |> hline(i = 20) |>
  merge_at(i = c(1:10), j = 1) |> merge_at(i = c(11:20), j = 1)|>
  # set_table_properties(layout = "autofit", align = "center") |>
  width(width = 0.6, j = 2:(dim(table_h)[2]-1)) |>
  width(width = 0.9, j = 1)



```

## Scientific uncertainty{-}

Spawning biomass is estimated to be at `r format(SSB["SSB_2025","Value"], big.mark = ",", digits = 1)` mt in 2025, with a sigma of `r format(SSB["SSB_2025","StdDev"]/SSB["SSB_2025","Value"], big.mark = ",", digits = 4)`. OFL is estimated to be `r format(report$derived_quants["OFLCatch_2025","Value"], big.mark = ",", digits = 1)` mt in 2019 with a coefficient of variation of `r format(report$OFL_sigma, big.mark = ",", digits = 4)`


<!-- ```{r} -->
<!-- #| label: tbl-i -->
<!-- #| echo: false -->
<!-- #| warning: false -->
<!-- #| tbl-cap: "Summary table of results for the assessment of Widow Rockfish." -->


<!-- table_i <- as.data.frame(read.csv(file.path(here::here(),"report/tables/exec_summ_tables/i_Summary_ES.csv"), stringsAsFactors = FALSE)) -->

<!-- colnames(table_i) <- gsub("\\.", " ", colnames(table_i)) -->
<!-- colnames(table_i) <- gsub("\\X", " ", colnames(table_i)) -->



<!-- flextable(table_i) %>% -->
<!--   merge_h(part = "header") %>% -->
<!--   merge_v(part = "header") %>% -->
<!--   border(part = "all") %>% -->
<!--   align(align = "center", part = "all") %>% -->
<!--   font(fontname = "Times New Roman", part = "all") %>% -->
<!--   bold(part = "header")%>% -->
<!--   autofit() %>% -->
<!--   colformat_num(j = 1, big.mark = "", digits = 0)%>% -->
<!--   fontsize(size = 9, part = "all")%>% -->
<!--   set_table_properties(layout = "autofit") -->


<!-- ``` -->


```{r}
#| label: fig-h
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Equilibrium yield curve for the base case model and associated target and limit reference points. Values are based on most recent fishery selectivity and distribution with steepness fixed at 0.720. The fraction unfished is relative to unfished spawning biomass."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
      file.path(here::here(),"figures/2025 base model r4ss plots/plots/yield2_yield_curve_with_refpoints.png")
)

```
