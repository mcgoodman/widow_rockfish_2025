# Executive Summary

<!-- 
Note r4ss::table_exec_summary() will create the required tables. 
It currently makes them as csv files. 
sa4ss::es_table_tex will convert them to text files formatted as LaTeX tables if you prefer.
-->

## Stock{-}

This is an update assessment of widow rockfish (*Sebastes entomelas*) that reside in the waters off California, Oregon, and Washington from the U.S.-Canada border in the north to the U.S.-Mexico border in the south. The most recent benchmark was conducted in 2015 [@hicks_status_2015] and first updated in 2019 [@adams_status_2019]. This assessment represents the second update of the 2015 benchmark stock assessment. Widow rockfish inhabit water depths of 25–370 m from northern Baja California, Mexico to Southeastern Alaska. Although catches north of the U.S.-Canada border and south of the U.S.-Mexico border were not included in this assessment, it is not certain if those populations contribute to the biomass of widow rockfish off of the U.S. West Coast, possibly through adult migration and/or larval dispersion. Following the 2015 benchmark assessment [@hicks_status_2015], this update assessment is based on a single costwide area model.

{{< pagebreak >}} 

## Catches{-}

Historically, fisheries have caught widow rockfish since the turn of the 20th century. Landings in the trawl fishery are estimated to have increased into the 1940s and remained relatively constant and small (below 1,000 mt per year) throughout the 1950s and into the 1960s before the foreign trawl fleet increased catches into the 1970s, with a peak at almost 5,000 mt in 1967. In the late 1970s a midwater trawl fishery developed for widow rockfish and catches increased rapidly with the discovery of large aggregations that form at night. 

Total landings of widow rockfish peaked in the early 1980s, increasing from approximately 1,000 metric tons (mt) in 1978 to over 25,000 mt in 1981. The large landings in the early 1980s were curtailed with trip limits beginning in 1982, which resulted in a decline in landings throughout the 1980s and 1990s following sequential reductions in the trip limits. From 2000 to 2003, landings of widow rockfish dropped from over 4,000 mt to about 40 mt and remained low through 2016. Catches increased rapidly following the quota share reallocation in 2017, and have been near or above 10,000 mt in all years between 2018-2024. Midwater trawl gears in groundfish and Pacific hake/whiting (*Merluccius productus*, hereafter ``hake'') fisheries account for the majority of the recent catch. 

Widow rockfish are a desirable market species and it is believed that discarding was low historically. However, management restrictions (e.g., trip limits) resulted in a substantial amount of discarding beginning in the early 1980s. Trawl rationalization was introduced in 2011. Between 2011 and 2024 very little discarding of widow rockfish is estimated to have occurred. Recent discards in the model informed by data from the West Coast Observer Program (WCGOP), and total catches (discards plus landings) are reported in addition to landings. Landings for the past ten years are in @tbl-a and for the entire time series in @fig-a.

{{< pagebreak >}} 

```{r}
#| label: tbl-a
#| echo: false
#| warning: false
#| tbl-cap: "Recent landings for the bottom trawl, midwater trawl, at-sea hake, net, and hook-and-line fisheries and the total landings across fisheries and the total mortality (discards + landings) (mt). 100% mortality is assumed for discards and catch sources are described below."

library("flextable")
library("dplyr")
library("officer")
library("here")

exec_tab_style <- function(ft) {
  ft %>% 
  font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 9, part = "all") %>% 
  bold(part="header") %>%
  hline(part="header") %>%
  hline_top(part="header") %>% hline_bottom() %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body") %>%
  width(width = 7/length(ft))
}

# Function to read in lenght-1 .Rdata / .rda with name of choice
read_rdata <- function(path) {load(path); get(ls()[ls() != "path"])}

#Old table 12
table_A <- read_rdata(here("report", "tables", "exec_summ_tables", "catches_es.rda"))

table_A <- table_A$table |> mutate(across(is.numeric, round, digits = 1))

table_A <- round(table_A, 2) # manually round bc flex table isn't working well

# # Build header map (multi-row header)
# header_df <- data.frame(
#   keys = names(table_A),
#   line1 = c("Year", "Bottom Trawl","Midwater Trawl","At-Sea Hake", "Net","Hook-and-line", "Total Landings","Total Mortality"),
#   stringsAsFactors = FALSE
# )

# Create flextable
flextable(table_A, col_keys = names(table_A)) %>%
  # set_header_df(mapping = header_df, key = "keys") %>%
  set_header_labels(names = names(table_A), values = c("Year", "Bottom Trawl","Midwater Trawl","At-Sea Hake", "Net","Hook-and-line", "Total Landings","Total Mortality")) %>% 
  # merge_h(part = "header") %>%
  # merge_v(part = "header") %>%
  # border(part = "all") %>%
  # align(align = "center", part = "all") %>%
  # font(fontname = "Times New Roman", part = "all") %>%
  # bold(part = "header")%>%
  colformat_num(j = 1, big.mark = "", digits = 0)%>%
  fontsize(size = 9, part = "all") %>%
  set_table_properties(layout = "autofit") %>% exec_tab_style # %>%
  # colformat_num(j = 2:ncol(table_A), big.mark = "", digits = 2) 


```


```{r}
#| label: fig-a
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Landings of widow rockfish from 1916 to 2024 for bottom trawl, midwater trawl, net, and hook- and-line fisheries, and catches of widow rockfish for the foreign (1966–1976) and Pacific Whiting (hake) fisheries (green)."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/catch5_total_catch_(including_discards)_stacked.png")
)

```

## Data and Assessment{-}

```{r}
#| include: false

model_path <- here::here("models", "2025 base model")
report <- r4ss::SS_output(dir = model_path, verbose = FALSE, printstats = FALSE)

```


This assessment uses the length- and age-structured modeling software Stock Synthesis (version 3.30.23.1). The coastwide population was modeled assuming separate growth and mortality parameters for males and females from 1916 to 2024.

The model includes catch, age, and length data for five fishing fleets: 1) a coastwide shore-based bottom trawl fleet (1916–2024), 2) a coastwide shore-based midwater trawl fleet (1979–2024), 3) a mostly midwater trawl fleet that targets hake and includes a foreign and at-sea fleet (1975–2024), a domestic shore-based fleet (1991–2024), and foreign vessels that targeted hake and rockfish between 1966–1976, 4) a net fishery consisting of catches mostly from California (1981–2024), and 5) a coastwide hook-and-line fishery (1916–2024). There are three older fishery-dependent CPUE indices retained from the 2015 benchmark: 1) Oregon bottom trawl (1984-1999), 2) hake at-sea foreign (1977-1988), and 3) hake at-sea domestic fleets (1983-1998).

The 2015 benchmark and 2019 update assessments estimated discards using retention curves for the bottom trawl, midwater trawl, and hook-and-line fleets based on discard biomass and length composition data from the \gls{wcgop}. Changes to the underlying discard length composition data for the hook-and-line fleet from \gls{wcgop} illustrated that very large recruitment events in 2013 and 2014 were mainly driven by very small amounts of composition data for a minor fleet responsible for less than one-tenth of a percent of the catch in the last decade. With the updated data, this led to implausible population dynamics, so the decision was made to add discard biomass from the \gls{gemm} to the landed catch for the hook-and-line fleet, rather than estimating retention. Retention is still estimated for the midwater and bottom trawl fleets, which have more available data.

Data from three fishery-independent surveys were also included in the model: 1) length compositions and an index for the \gls{s-tri} were retained from the 2015 benchmark (1977–2004), 2) age-at-length, length, and an index for the \gls{s-wcgbt} (2003-2024), and 3) a recruitment index from the National Marine Fisheries Service (NMFS) Southwest Fisheries Science Center (SWFSC) and Northwest Fisheries Science Center (NWFSC)/Pacific Whiting Conservation Cooperative (PWCC) Midwater Trawl Survey (2004-2024).

The base model estimated parameters for length-based selectivity for all fleets and surveys, retention curves for the bottom trawl and midwater trawl fleets, a sex-specific length-at-age relationship, sex-specific natural mortality, and recruitment deviations. A Beverton-Holt stock-recruitment function was used to model productivity, and the steepness parameter was fixed at `r report$parameters["SR_BH_steep","Value"]` based on a steepness meta-analysis [@thorson_steep_2019] for west coast rockfishes. 

Natural mortality and steepness are major sources of uncertainty. We used high and low combinations of these parameters to define a range of states of nature, with results presented in a decision table. 

<!-- The major axis of uncertainty was determined to define a range of states of nature and results are presented in a decision table.  -->

<!-- Although there are many types of data available for widow rockfish since the late 1970s, which were used in this assessment, there is little information about steepness and natural mortality, and recent recruitment (although likelihood profiles in this update assessment suggest additional data has contributed higher certainty in natural mortality estimates). Estimates of steepness are uncertain partly because of variable recruitment. Uncertainty in natural mortality is common in many fish stock assessments even when length and age data are available. Finally, there is little information about the strength of recent recruitment because the young fish are seen with a lower probability in the fisheries and surveys. These uncertainties were characterized as best as possible in the predictions and projections from this assessment. -->

## Stock biomass and dynamics{-}

```{r}
#| include: false

model_path <- here::here("models", "2025 base model")
report <- r4ss::SS_output(dir = model_path, verbose = FALSE, printstats = FALSE)

catch_sum <- aggregate(report$catch$Exp, by = list(Yr = report$catch$Yr), sum)

table_b <- read_rdata(here::here("report", "tables", "exec_summ_tables", "ssb_es.rda"))$table
names(table_b) <- c("Year", "SSB", "SSB_Lwr", "SSB_Upr", "Bratio", "Bratio_Lwr", "Bratio_Upr")

require("dplyr")

SSB <- report$derived_quants[report$derived_quants$Label %in% paste0("SSB_", 1916:2036),]
SSB$Year <- as.integer(gsub("SSB_", "", SSB$Label))

Bratio <- report$derived_quants[report$derived_quants$Label %in% paste0("Bratio_", 1916:2036),]
Bratio$Year <- as.integer(gsub("Bratio_", "", Bratio$Label))

# SSB <- SSB |>
#   select(Year, SSB = Value, SD = StdDev) |>
#   mutate(
#     mu_log = log(SSB) - 0.5 * log((SD^2)/(SSB^2) + 1),
#     sigma_log = sqrt(log(1 + ((SD^2) / (SSB^2)))),
#     lower = qlnorm(0.025, mu_log, sigma_log),
#     upper = qlnorm(0.975, mu_log, sigma_log)
#   )

```


The time series of estimated spawning biomass and relative spawning biomass is in @fig-b and @fig-c, respectively, and for the most recent year in @tbl-b. The spawning biomass declined rapidly with the developing domestic midwater fishery in the late 1970s and early 1980s. Low abundance continued until 2000. A combination of strong recruitment and low catches resulted in a steady increase in spawning biomass through 2016. A target fishery for widow rockfish was reestablished in 2017. The stock exhibits a decline in most recent years with the increased catches since 2017.

The 2025 spawning biomass relative to unfished equilibrium spawning biomass is `r round(table_b$Bratio[table_b$Year == 2025] * 100)`, above the target of 40% (95% confidence interval of `r round(table_b$Bratio_Lwr[table_b$Year == 2025] * 100)` - `r round(table_b$Bratio_Upr[table_b$Year == 2025] * 100)`%). 

Spawning biomass is estimated to be at `r format(SSB$Value[SSB$Year == 2025], big.mark = ",", digits = 1)` mt in 2025 (95% confidence interval of `r paste(format(table_b[table_b$Year == 2025, c("SSB_Lwr", "SSB_Upr")], big.mark = ",", digits = 1), collapse = " - ")` mt). The uncertainty in the estimated spawning biomass is high, especially in the early years. 

```{r}
#| label: fig-b
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Estimated female spawning biomass time-series from the base model (solid line) with an approximate asymptotic 95% confidence interval (dashed lines)."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/ts7_Spawning_output_with_95_intervals.png")
)

```

```{r}
#| label: fig-c
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Estimated relative spawning biomass (depletion) with approximate 95% asymptotic confidence intervals (dashed lines) for the base case assessment model."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/ts9_Relative_spawning_biomass_intervals.png")
)

```
{{< pagebreak >}} 
```{r}
#| label: tbl-b
#| echo: false
#| warning: false
#| tbl-cap: "Recent trend in estimated female spawning biomass (mt) and relative spawning biomass (depletion)."

#Old table 12
table_B <- read_rdata(here::here("report", "tables", "exec_summ_tables", "ssb_es.rda"))$table

colnames(table_B) <- c("Year", 
                       "Spawning Biomass (mt)", 
                       "Lower Interval (SSB, mt)", "Upper Interval (SSB, mt)" , 
                       "Fraction Unfished", 
                       "Lower Interval (Frac. Unfish.)", "Upper Interval (Frac. Unfish.)")

# table_B <- table_B |> 
#   mutate(
#     Year = as.character(Year),
#     SSB = format(round(`Spawning Biomass (mt)`), big.mark = ","),
#     SSB_lower = format(round(`Lower Interval (mt)`, 0), big.mark = ","), 
#     SSB_upper = format(round(`Upper Interval (mt)`, 0), big.mark = ","),
#     SSB_CI = paste0(SSB_lower, " - ", SSB_upper), 
#     Bratio_CI = paste0(round(`Lower Interval`, 3),  " - ", round(`Upper Interval`, 3))
#   ) |>
#   dplyr::select(Year, SSB, SSB_CI, `Fraction Unfished`, Bratio_CI)
# 
# colnames <- c(
#   "Year", "Spawning Biomass", "95% Confidence Interval", 
#   "Estimated Depletion (%)", "95% Confidence Interval"
# )

# Create flextable
# flextable(table_B, col_keys = names(table_B)) |> 
#   set_header_labels(names = names(table_B), values = colnames) |> 
#   set_table_properties(layout = "autofit") %>% exec_tab_style

flextable(table_B) |> 
  set_table_properties(layout = "autofit") %>% exec_tab_style

```

{{< pagebreak >}} 

## Recruitment{-}

Recruitment deviations were estimated for the entire time series modeled. There is little information regarding recruitment prior to 1965, and the uncertainty in these estimates is expressed in the model. 

There are several very large, but uncertain, estimates of recruitment (in descending order of magnitude) in 1970, 2008, 2016, and 1971. The five lowest recruitments (in ascending order) occurred in 2012, 2019, 2020, 2011, and 1976. Estimates of recruitment appear to be episodic and characterized by periods of low recruitment (@fig-d, @fig-e).

The 2019 update assessment [@adams_status_2019] estimated the largest recruitment on record in 2013, and above-average recruitment in 2014. With the more stable treatment of hook-and-line discards in this assessment, and the additional years of data, 2013 is now estimated as only the tenth-largest recruitment on record, and 2014 is estimated as below average.

```{r}
#| label: fig-d
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Time-series of estimated recruitments (medians as open circles) for the base case model with approximate asymptotic 95% confidence interval (vertical bars). Estimated mean unfished equilibrium recruitment (R0) is shown as the closed circle with a 95% confidence interval at the beginning of the time series."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/ts11_Age-0_recruits_(1000s)_with_95_asymptotic_intervals.png")
)

```


```{r}
#| label: tbl-c
#| echo: false
#| warning: false
#| tbl-cap: "Recent estimated trend in widow rockfish recruitment with approximate 95% confidence intervals determined from the base model."
#| out.width: "90%"
#| fig-align: "center"

table_c <- read_rdata(here::here("report", "tables", "exec_summ_tables", "recr_es.rda"))$table

colnames(table_c) <- c("Year", 
                       "Recruitment (1,000s)", "Lower Interval (Rec, 1,000s)", "Upper Interval (Rec, 1,000s)", 
                       "Recruitment Deviations", "Lower Interval (Rec Devs)", "Upper Interval (Rec Devs)" )

# table_c <- table_c |> 
#   mutate(
#     Year = as.character(Year),
#     recr = format(round(`Recruitment (1,000s)`), big.mark = ","),
#     recr_lower = format(round(`Lower Interval (1,000s)`, 0), big.mark = ","), 
#     recr_upper = format(round(`Upper Interval (1,000s)`, 0), big.mark = ","),
#     recr_CI = paste0(recr_lower, " - ", recr_upper), 
#     recdev_CI = paste0(round(`Lower Interval`, 3),  " - ", round(`Upper Interval`, 3)), 
#     `Recruitment Deviations` = round(`Recruitment Deviations`, 3)
#   ) |>
#   dplyr::select(Year, recr, recr_CI, `Recruitment Deviations`, recdev_CI)
# 
# colnames <- c(
#   "Year", "Estimated recruitment (number in thousands)", "95% Confidence Interval", 
#   "Recruitment \nDeviations", "95% Confidence Interval"
# )

# Create flextable
# flextable(table_c, col_keys = names(table_c)) |> 
#   set_header_labels(names = names(table_C), values = colnames) %>%
#   colformat_num(j=3, big.mark = ",")%>%
#   exec_tab_style
flextable(table_c) %>%
  colformat_num(j = 1, big.mark = "") %>%
  colformat_num(j=3, big.mark = ",")%>%
  exec_tab_style

```
{{< pagebreak >}} 

## Exploitation status{-}

The population declined throughout the 1980s and 1990s when fishing intensity was above the management target and overfishing was occurring. The population then increased from around 2000 to 2016 when fishing intensity was well below the management management target. Fishing intensity has increased substantially since 2017, and is estimated to have been above the management target since 2018 (i.e., overfishing is occurring), though the relative spawning output remains above the management target of 40% (i.e., the population is not overfished). Recent fishing intensities are in @tbl-d, and a full time series of relative spawning output and fishing intensity is in @fig-e.

```{r}
#| label: tbl-d
#| echo: false
#| warning: false
#| tbl-cap: "Recent trend in spawning potential ratio and summary exploitation rate. Harvest rate is defined as catch divided by age 4+ biomass."

table_d <- read_rdata(here("report", "tables", "exec_summ_tables", "spr_es.rda"))$table

# table_d <- table_d |> 
#   mutate(
#     Year = as.character(Year),
#     across(is.numeric, \(x) round(x, 3)),
#     SPR_CI = paste0(`Lower Interval (SPR)`, " - ", `Upper Interval (SPR)`), 
#     rate_CI = paste0(`Lower Interval (Rate)`,  " - ", `Upper Interval (Rate)`)
#   ) |>
#   dplyr::select(Year, `(1-SPR)/(1-SPR50%)`, SPR_CI, `Exploitation Rate`, rate_CI)
# 
# colnames <- c(
#   "Year", "Estimated \n(1-SPR)/(1-SPR50%)", "95% Confidence Interval", 
#   "Harvest rate \n(proportion)", "95% Confidence Interval"
# )

# Create flextable
# flextable(table_d, col_keys = names(table_d)) %>%
#   set_header_labels(names = names(table_C), values = colnames) %>%
#   exec_tab_style
flextable(table_d) %>%
  exec_tab_style

```

{{< pagebreak >}} 

```{r}
#| label: fig-e
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Phase plot of fishing intensity versus fraction unfished. Each point represents the spawning biomass ratio at the start of the year and the relative fishing intensity in that same year. Lines through the final point show 95% intervals based on the asymptotic uncertainty for each dimension. The shaded ellipse is a 95% region which accounts for the estimated correlation between the two quantities."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
    file.path(here::here(),"figures/2025 base model r4ss plots/plots/SPR4_phase.png")
)

```

## Ecosystem considerations{-}

Recruitment is a key mechanism by which the ecosystem may directly impact the population dynamics of widow rockfish; however, the specific pathways through which environmental conditions exert influence on widow rockfish dynamics are unclear. Changes in the environment may result in changes in other population processes, as well. Unfortunately, there are few data available for widow rockfish that provide insights into these effects. 

Fishing has effects on habitats, in addition to the population itself. Rockfish are often associated with habitats containing living structures such as sponges and corals, and fishing may alter that habitat to a less desirable state. Recent studies on essential fish habitat are beginning to characterize important locations for rockfish throughout their life history; however there is little current information available to evaluate the specific effects of fishing on the ecosystem issues specific to widow rockfish.

## Reference points{-}

```{r}
#| include: false

table_e <- read_rdata(here::here("report", "tables", "exec_summ_tables", "reference_points.rda"))$table

ref_pts <- table_e
colnames(ref_pts) <- c("Label", "Est", "Lwr", "Upr")

ref_pts <- setNames(
  lapply(seq_len(nrow(ref_pts)), function(i) {
    vals <- ref_pts[i, c("Est", "Lwr", "Upr")]
    vals <- format(round(as.numeric(vals)), big.mark = ",", scientific = FALSE)
    setNames(as.list(vals), c("Est", "Lwr", "Upr"))
  }),
  nm = gsub("\\\\%", "%", ref_pts$Label)
)
```

Reference points were calculated using the estimated selectivities and average catch distribution among fleets in the most recent five years of the model (2019-2024). A list of estimates of the current state of the population, as well as reference points based on 1) a target unfished spawning output of 40%, 2) a spawning potential ratio of 0.5, and 3) the model estimate of maximum sustainable yield (MSY), are all listed in @tbl-e. SPR, or the spawning potential ratio, is the fraction of expected lifetime reproductive output under a given fishing intensity divided by unfished expected lifetime reproductive output. While the estimate of total population scale has remained relatively steady across the 2015, 2019, and 2025 assessments, unfished recruitment and natural mortality, which are positively correlated, have declined from 2015 (female natural mortality of 0.157 yr^-1^) to 2019 (0.144 yr^-1^) to 2025 (`r round(report$M_at_age[1, 4], 3)` yr^-1^). Thus, although the scale is estimated consistently, additional years of data (in particular, age composition data) following the re-opening of the fishery have led the model to estimate that the population is less productive, which results in lower yields at all three reference points (proxy based on spawning output, proxy based on fishing intensity, and model estimate of MSY).

```{r}
#| label: tbl-e
#| echo: false
#| warning: false
#| tbl-cap: "Summary of reference points and management quantities for the base case model."

table_e <- table_e |> mutate(across(is.numeric, round, digits = 2))


flextable(table_e) %>%
  merge_h(part = "header") %>%
  merge_v(part = "header") %>%
  border(part = "all") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", j = 1) %>%
  font(fontname = "Times New Roman", part = "all") %>%
  bold(part = "header")%>%
  bold(i = c(6,11,16)  ,part="body")%>%
  colformat_num( digits = 2)%>%
  fontsize(size = 9, part = "all")%>%
  set_table_properties(layout = "autofit")

```

{{< pagebreak >}} 

## Management performance{-}

Since annual catch limits for widow rockfish increased in 2017 and new fishing opportunities for use of midwater trawl gear became available, attainment of the annual catch limit has been high (@tbl-f). Specifically, attainment of the ACL has exceeded 70% every year since 2018, averaged 77% from 2017-2024, and was as high as 88% in 2022. 

```{r}
#| label: tbl-f
#| echo: false
#| warning: false
#| tbl-cap: "Recent trend in total catch and commercial landings (mt) relative to the management guidelines. Estimated total catch reflects the commercial landings plus the model estimated dead discarded biomass."

table_f <- read_rdata(here("report", "tables", "exec_summ_tables", "recent_management.rda"))$table

#colnames <- c("Year", "OFL (mt) (termed ABC prior to 2011)", "ABC (mt)", "ACL (mt)", "Estimated Total Catch (mt)", "Estimated Total Mortality (mt)")

# Create flextable
flextable(table_f) |> 
  colformat_num(j = 1, big.mark = "", digits = 0) %>%
  exec_tab_style

```

## Unresolved problems and major uncertainties

Discuss fit to survey data and natural mortality.

## Harvest projections and decision table{-}

```{r}
#| include: false

##dec table params
dec_table_pars <- report$parameters|> #make sure to ppull from report, not input file so est values are used
  mutate(
         value = Value,
         sd = if_else(is.na(Parm_StDev),Pr_SD,Parm_StDev))|> #If est par, use param sd, otherwise use prior sd
  filter(Num %in% c(1,13,24))|> #natM Female, natM male, steepness
  select(value,sd)|>
  mutate(
    q125 = round(qnorm(0.125,mean = value,sd = sd),3), #apply the quantiles
    q875 = round(qnorm(0.875,mean = value,sd = sd),3),
    phase = -1,
    name = c("NatM_p_1_Fem_GP_1", #name the parms - easier to do manually as report and r4ss::read() have different parameter names
             "NatM_p_1_Mal_GP_1",
             "SR_BH_steep") 
  )

#dec tables stuff
dec_table_pars["NatM_uniform_Fem_GP_1","q125"]
colnames(dec_table_pars)

dec_table_res <- read.csv(here("data_derived", "decision_table", "dec_table_formatted.csv"))

##gmt stuff
gmt_catch <- data.frame(read.csv(here("data_provided", "gmt_forecast_catch", "GMT_forecast_catch.csv"))|>
  group_by(year)|>
  summarise(total_catch = sum(catch_mt)))

dec_table_summ <- list(
  "p45_2027" = dec_table_res|>filter(scenario == "P*0.45" & yr == 2027)|>pull(catch),
  "p45_2036" = dec_table_res|>filter(scenario == "P*0.45" & yr == 2036)|>pull(catch),
  "p40_2027" = dec_table_res|>filter(scenario == "P*0.40" & yr == 2027)|>pull(catch),
  "p40_2036" = dec_table_res|>filter(scenario == "P*0.40" & yr == 2036)|>pull(catch)
)
```


Two categories of parameters that greatly contributed to uncertainty in the results were natural mortality (an important estimated parameter) and steepness (not estimated in the model). A combination of these two factors was used as the axis of uncertainty to define low and high states of nature. This differed from the 2019 assessment which included a third factor, 2013 recruitment strength. The 2013 year class is no longer a major source of uncertainty, and there is no recent similarly large estimate of recruitment. The 12.5% and 87.5% quantiles for female and male natural mortality (independently) were chosen as low and high values (`r dec_table_pars["NatM_uniform_Fem_GP_1","q125"]` yr^-1^ and `r dec_table_pars["NatM_uniform_Fem_GP_1","q875"]` yr^-1^ for females; `r dec_table_pars["NatM_uniform_Mal_GP_1","q125"]` yr^-1^ and `r dec_table_pars["NatM_uniform_Mal_GP_1","q875"]` yr^-1^ for males). Steepness is probably the most important factor since it was fixed in the base model and is not incorporated in the estimation uncertainty. The 12.5% and 87.5% quantiles from the steepness prior (without widow rockfish data) were used to define the low and high values of steepness (`r dec_table_pars["SR_BH_steep","q125"]` and `r dec_table_pars["SR_BH_steep","q875"]`). The low combination of these two factors defined the low state of nature and the high combination of these two factors defined the high state of nature. The predictions of spawning biomass in 2025 from the low and high states of nature are close to the 12.5% and 87.5% lognormal quantiles from the base model.

A twelve year projection of the base model with two catch streams based on ACL adjustments of 0.45 P* and 0.40 P* were conducted (@tbl-h).

Projections with catches based on the predicted annual catch limit (ACL) using the SPR rate of 50%, the 40:10 control rule, and a 0.45 P* adjustment using a sigma of 0.50 in 2027 suggest that the spawning biomass will decrease over the projection period for all states of nature (@tbl-h). Predicted ACL catches range from `r format(dec_table_summ$p45_2027, big.mark = ",", digits = 1)` mt in 2027 to `r format(dec_table_summ$p45_2036, big.mark = ",", digits = 1)` mt in 2036. 

Projections with catches based on the predicted annual catch limit (ACL) using the SPR rate of 50%, the 40:10 control rule, and a 0.40  P* adjustment using a sigma of 0.50 from 2027 onward suggest that the spawning biomass will decrease over the projection period for all states of nature. Predicted ACL catches range from `r format(dec_table_summ$p40_2027, big.mark = ",", digits = 1)` mt in 2027 to `r format(dec_table_summ$p40_2036, big.mark = ",", digits = 1)` mt in 2036. 


```{r}
#| label: tbl-g
#| echo: false
#| warning: false
#| tbl-cap: "Potential OFLs (mt), ABCs (mt), ACLs (mt), the buffer between the OFL and ABC, estimated spawning biomass (mt), and fraction of unfished spawning biomass. The predicted OFL is the calculated total catch determined by FSPR=50%."

table_g <- read_rdata(here::here("report", "tables", "exec_summ_tables", "projections.rda"))$table
table_g <- round(signif(table_g[,-c(2:3)], 5), 3)


#manually add buffer
buffer <- r4ss::SS_readforecast(file = here(model_path,"forecast.ss"),verbose =  FALSE)$Flimitfraction_m$fraction

### modify projections table for model that falls below target
# get table from list saved above

# get buffers from forecast file
buffers <- r4ss::SS_readforecast(file = here(model_path,"forecast.ss"),verbose =  FALSE)$Flimitfraction_m
# which rows in the table are missing buffer and ABC values?
NA_rows <- is.na(table_g[["Buffer"]])
# fill in Buffer column from forecast file values
table_g[["Buffer"]][NA_rows] <- buffers[["fraction"]][match(table_g[["Year"]][NA_rows], buffers[["year"]])]
# fill in ABC as product of Buffer and OFL
table_g[NA_rows, "ABC (mt)"] <- table_g[["Buffer"]][NA_rows] * table_g$"OFL (mt)"[NA_rows]

#replace NA with dashes
table_g[is.na(table_g)] <- "-"

flextable(table_g) %>%
  colformat_num(j = 1, big.mark = "", digits = 0) %>%
  set_table_properties(layout = "autofit") %>% 
  exec_tab_style() %>% 
  fit_to_width(max_width = 7.5)


```

{{< pagebreak >}} 

```{r}
#| label: tbl-h
#| echo: false
#| warning: false
#| tbl-cap: "Summary table of 12-year projections beginning in 2027 for alternate states of nature based on the axis of uncertainty (a combination of M, h). Columns range over low, mid, and high state of nature, and rows range over different assumptions of total catch levels (discards + retained). Catches in 2025 and 2026 are allocated using the percentage of landings for each fleet in 2019-2024."

table_h <- read.csv(here("data_derived", "decision_table", "dec_table_formatted.csv"))

# table_h <- table_h[,2:6]
# break up management & state of nature
# table_h$management_choice <- substr(table_h$name, start = 1, stop = 2)
table_h$scenario <- plyr::revalue(table_h$scenario,
                                  c("Constant catch" = "Constant catch (9,000 K)",
                                    "P*0.40" = "ACLp*=0.40, sigma=0.50",
                                    "P*0.45" = "ACLp*=0.45, sigma=0.50"))
# table_h$stnat <- substr(table_h$name, start = 4, stop = 7)

# pivot
# table_h |>
#   tidyr::pivot_wider(names_from = stnat, values_from = c(SpawnBio, dep), id_cols=-name) |>
#   # getting format closer...
#   dplyr::select(c(4, 1, 3, 2, 5, 8, 6, 9, 7, 10)) ->
#   # reordering for ease
#   # note this only works if OFL included, otherwise need to subtract 1 from col number
#   table_h_reorg

# colnames(table_h_reorg) <- c("Management decision", "Year", "OFL", "catch (mt)",
#                              "Spawning biomass (mt)", "Depletion (%)",
#                              "Spawning biomass (mt)", "Depletion (%)",
#                              "Spawning biomass (mt)", "Depletion (%)")

# flextable(table_h) |>
#   set_header_labels(values = c(scenario = "Management decision",
#                                yr = "Year",
#                                # OFL = "OFL",
#                                catch = "catch (mt)",
#                                SpawnBio_low = "Spawning biomass (mt)",
#                                dep_low = "Depletion (%)",
#                                SpawnBio_base = "Spawning biomass (mt)",
#                                dep_base = "Depletion (%)",
#                                SpawnBio_high = "Spawning biomass (mt)",
#                                dep_high = "Depletion (%)")
#                     ) |>
#   add_header_row(values = c("", "Low", "Base", "High"), colwidths = c(3, 2, 2, 2)) |>
#   add_header_row(values = c("", "State of nature"), colwidths = c(3, 6)) |>
#   align(align = "center", part = "all") |>
#   font(fontname = "Times New Roman", part = "all") |>
#   fontsize(size = 9, part ="all") |>
#   bold(part = "header", i = 1:2) |>
#   bold(part = "header", i = 3, j = 1) |>
#   colformat_num(j = 2, big.mark = "", digits = 0) |>
#   border_inner(part="header") |> border_outer() |> # header and outside border
#   vline(j = c(1, 3, 5, 7)) |> hline(i = 10) |> hline(i = 20) |>
#   merge_at(i = c(1:10), j = 1) |> merge_at(i = c(11:20), j = 1) |> merge_at(i = c(21:30), j = 1) |>
#   # set_table_properties(layout = "autofit", align = "center") |>
#   width(width = 0.6, j = 2:(dim(table_h)[2]-1)) |>
#   width(width = 0.9, j = 1)

table_h <- table_h|>filter(scenario != "Constant catch (9,000 K)")|>select(-X)
# 
# flextable(table_h) |>
#   set_header_labels(values = c(scenario = "Management decision",
#                                yr = "Year",
#                                # OFL = "OFL",
#                                catch = "catch (mt)",
#                                SpawnBio_low = "Spawning biomass (mt)",
#                                dep_low = "Depletion (%)",
#                                SpawnBio_base = "Spawning biomass (mt)",
#                                dep_base = "Depletion (%)",
#                                SpawnBio_high = "Spawning biomass (mt)",
#                                dep_high = "Depletion (%)")
#                     ) |>
#   add_header_row(values = c("", "Low", "Base", "High"), colwidths = c(3, 2, 2, 2)) |>
#   add_header_row(values = c("", "State of nature"), colwidths = c(3, 6)) |>
#   align(align = "center", part = "all") |>
#   font(fontname = "Times New Roman", part = "all") |>
#   fontsize(size = 9, part ="all") |>
#   bold(part = "header", i = 1:2) |>
#   bold(part = "header", i = 3, j = 1) |>
#   colformat_num(j = 2, big.mark = "", digits = 0) |>
#   border_inner(part="header") |> border_outer() |> # header and outside border
#   vline(j = c(1, 3, 5, 7)) |> hline(i = 12) |> hline(i = 24) |> hline(i = 36)|>
#   merge_at(i = c(1:12), j = 1) |> merge_at(i = c(13:24), j = 1)|> merge_at(i = c(25:36), j = 1)|>
#   border(i = c(12, 24, 36), j = 1,
#          border.bottom = officer::fp_border(color = "black", width = 1))|>  # set_table_properties(layout = "autofit", align = "center") |>
#   width(width = 0.6, j = 2:(dim(table_h)[2]-1)) |>
#   width(width = 0.9, j = 1)

flextable(table_h) |>
  set_header_labels(values = c(scenario = "Management decision",
                               yr = "Year",
                               catch = "catch (mt)",
                               SpawnBio_low = "Spawning biomass (mt)",
                               dep_low = "Depletion (%)",
                               SpawnBio_base = "Spawning biomass (mt)",
                               dep_base = "Depletion (%)",
                               SpawnBio_high = "Spawning biomass (mt)",
                               dep_high = "Depletion (%)")
                    ) |>
  add_header_row(values = c("", "Low", "Base", "High"), colwidths = c(3, 2, 2, 2)) |>
  add_header_row(values = c("", "State of nature"), colwidths = c(3, 6)) |>
  align(align = "center", part = "all") |>
  font(fontname = "Times New Roman", part = "all") |>
  fontsize(size = 8, part = "all") |>
  padding(padding.top = -2, part = "all") |>
  bold(part = "header", i = 1:2) |>
  bold(part = "header", i = 3, j = 1) |>
  colformat_num(j = 2, big.mark = "", digits = 0) |>
  border_inner(part = "header") |> border_outer() |>
  vline(j = c(1, 3, 5, 7)) |> 
  merge_at(i = 1:12, j = 1) |> merge_at(i = 13:24, j = 1) |>
  # border(i = c(12), j = 1, border.bottom = officer::fp_border(color = "black", width = 1)) |>
  # border(i = c(24), j = 1, border.bottom = officer::fp_border(color = "black", width = 1)) |>
  width(width = 0.6, j = 2:(ncol(table_h) - 1)) |>
  width(width = 0.9, j = 1)|>
    hline(i = 12)|>
  hline_bottom(j = 9)

```

{{< pagebreak >}} 

## Scientific uncertainty{-}

The model estimate of the log-scale standard deviation of the overfishing limit (OFL) in 2025 is `r round(report$OFL_sigma, 3)`. This is less than the default SSC value of 0.5 for a category 1 assessment, so harvest projections assume an initial sigma of 0.5.


<!-- ```{r} -->
<!-- #| label: tbl-i -->
<!-- #| echo: false -->
<!-- #| warning: false -->
<!-- #| tbl-cap: "Summary table of results for the assessment of Widow Rockfish." -->


<!-- table_i <- as.data.frame(read.csv(file.path(here::here(),"report/tables/exec_summ_tables/i_Summary_ES.csv"), stringsAsFactors = FALSE)) -->

<!-- colnames(table_i) <- gsub("\\.", " ", colnames(table_i)) -->
<!-- colnames(table_i) <- gsub("\\X", " ", colnames(table_i)) -->



<!-- flextable(table_i) %>% -->
<!--   merge_h(part = "header") %>% -->
<!--   merge_v(part = "header") %>% -->
<!--   border(part = "all") %>% -->
<!--   align(align = "center", part = "all") %>% -->
<!--   font(fontname = "Times New Roman", part = "all") %>% -->
<!--   bold(part = "header")%>% -->
<!--   autofit() %>% -->
<!--   colformat_num(j = 1, big.mark = "", digits = 0)%>% -->
<!--   fontsize(size = 9, part = "all")%>% -->
<!--   set_table_properties(layout = "autofit") -->


<!-- ``` -->

<!--
```{r}
#| label: fig-h
#| echo: false
#| warning: false
#| eval: true
#| fig-cap: "Equilibrium yield curve for the base case model and associated target and limit reference points. Values are based on most recent fishery selectivity and distribution with steepness fixed at 0.720. The fraction unfished is relative to unfished spawning biomass."
#| out.width: "90%"
#| fig-align: "center"

knitr::include_graphics(
      file.path(here::here(),"figures/2025 base model r4ss plots/plots/yield2_yield_curve_with_refpoints.png")
)

```
-->


## Unresolved problems and major uncertainties

```{r echo = FALSE, results = 'hide', message = FALSE, warning = FALSE }

steep_proflik <- read.csv(here::here("report", "tables", "SR_BH_steep_quant_table.csv"))
names(steep_proflik)[1] <- "var"

steep_yspr50 <- as.numeric(steep_proflik[steep_proflik$var == "Yield SPR 50",-1])
steep_yspr50 <- round(steep_yspr50[round(steep_yspr50) > 0])

```

Major sources of uncertainty include landings, discards, natural mortality, and recruitment, which are discussed below. 

Because widow rockfish is a marketable species, historical discard rates were likely lower than less desirable or smaller species. This assessment assumed that discarding was nearly negligible before management restrictions began in 1982. Once trip limits were introduced, discarding tended to be an all or none event, and detecting large, but rare, discard events with far less than 100% observer coverage has a low probability. From 2002 onward, the WCGOP has provided data on discards from vessels that were randomly selected for observer coverage, thus some uncertainty is present in the total amount discarded. The implementation of trawl rationalization in 2011 resulted in almost 100% observer coverage for the trawl fleet and very little incentive to discard widow rockfish. The open access fixed-gear fleet is not monitored by the full observer coverage required under trawl rationalization. Discard mortality is assumed to be 100%, which may overestimate actual mortality (Jarvis & Lowe, 2007), but given the low number of discards, is likely to have a minimal effect on assessment results.

There may also be uncertainty in the ability of bottom trawl surveys to be a reliable measure of widow abundance, which spend a significant portion of their time in mid-water (Wilkins 1986). Multiple surveys are used in the assessment, but further consideration of additional surveys is reasonable.

Widow rockfish is a relatively long-lived fish, and natural mortality is likely to be lower than many species of fish, such as gadoids. Ages above 50 years have been observed and it is expected that natural mortality could be less than 0.10 yr^-1^ (the median of the prior for natual mortality used in this assessment). However, even with length and age data available back to the late 1970s, natural mortality was estimated at `r round(report$parameters["NatM_uniform_Fem_GP_1",]$Value, 3)` for females and `r round(report$parameters["NatM_uniform_Mal_GP_1",]$Value, 3)` yr^-1^ for males, with a small amount of uncertainty (e.g., a `r paste0(round(100 * report$parameters["NatM_uniform_Fem_GP_1",]$Parm_StDev/report$parameters["NatM_uniform_Fem_GP_1",]$Value, 1), "%")` coefficient of variation for females). This assessment attempts to capture that uncertainty by estimating natural mortality (M) and integrating that uncertainty into the derived biomass estimates, as well as additional uncertainty by including levels outside of the predicted interval in a decision table. One contributing factor to this change is the increase in the mean age of the catch observed by the \gls{s-wcgbt survey in recent years. These observations are poorly fit by the model, and considertation should be given in future to structural changes which may improve the fit to \gls{s-wcgbt CAAL data. One possible explanation as to the increased observation of older fish is that successfully rebounding of the stock as a result of reduced fishing pressure form 2003-2016 allowed year classes to grow older and are now being fully observed by \gls{s-wcgbt.

Model sensitivities and profiles over M showed that current stock status was highly sensitive to the assumption about natural mortality. Notably, the estimated natural mortality values for both sexes from this assessment are lower than those from the 2015 and 2019 assessments, for which natural mortality was estimated above 0.15 yr^-1^ and 0.14 yr^-1^, respectively.  The estimates of M varied slightly depending on the weight given to age and length data, or removing recent years of data, but M was always estimated above 0.12 yr^-1^. The likelihood profile over natural mortality provides support for values up to or above 0.14 yr^-1^, but with greater curvature than in the 2019 assessment, suggesting additional data has reduced the support for higher natural mortality values.

Steepness was fixed at 0.720 in the base model, but a likelihood profile showed that it would be estimated at a value less than that. Estimates of M increased with lower steepness, while unfished equilibrium spawning biomass increased and current spawning biomass decreased. Sustainable yields at the SPR50% reference harvest rate ranged from approximately `r min(steep_yspr50)` to `r max(steep_yspr50)` mt depending on the value of steepness.

## Research and Data Needs

<!-- 1. Describe progress on Research and Data Needs items identified in the most recent previous stock assessment document and associated STAR panel report.  -->
<!-- 2. Describe new research and data needs and specify their priority (high, medium, low).  -->

<!-- There are many areas of research that could be improved to benefit the understanding and assessment of widow rockfish: -->

- **Natural mortality:** Uncertainty in natural mortality translates into uncertain estimates of status and sustainable fishing levels for widow rockfish. The collection of additional age data, re-reading of older age samples, reading old age samples that are unread, and improved understanding of the life-history of widow rockfish may reduce that uncertainty. Investigating the ageing error and bias would help to understand the influences that the age data have on this assessment, particularly the influence of age data on natural mortality.

- **Historical landings and discards:** Although progress has been made in reconstructing historical landings of rockfish on the U.S. West Coast, the historical landings and discards continue to be uncertain for widow rockfish and improvements would increase the certainty that fishing removals are applied appropriately. Because landings are assumed to be known exactly in the assessment model, uncertainty in the predictions does not include uncertainty in the landings. A thorough look at historical landings, species compositions, and discarding practices would reduce the potential uncertainty that is not entirely accounted for.

<!-- - **Maturity and fecundity::** There are few studies on the maturity of widow rockfish and even less recent information. There have been no studies that reported results of a histological analysis. Further research on the maturity and fecundity of widow rockfish, the potential differences between areas, the possibility of changes over time would greatly improve the assessment of these species. -->

<!-- - **Age data and error:** There is a considerable amount of error in the age data and potential for bias. Investigating the ageing error and bias would help to understand the influences that the age data have on this assessment. Disagreement between surface reads of age versus break-and-burn reads is worth more investigation. -->

- **Sex-specific selectivity:** The midwater and bottom trawl length-composition data fits showed divergent residual patterns between male and female fish. The underlying mechanism driving this pattern is unclear, and could be related to growth, sexing error, or to sex-specific selectivity (e.g., when widow rockfish aggregate, sexes possibly may be aggregating separately). Sex-specific selectivity for these two fleets could be explored or included to address this.

- **Coastwide understanding of stock structure, biology, connectivity, and distribution:** This is a stock assessment for widow rockfish off of the west coast of the U.S. and does not consider data from British Columbia or Alaska. Further investigating and comparing the data and predictions from British Columbia and Alaska to determine if there are similarities with the U.S. West Coast observations would help to define the connectivity between widow rockfish north and south of the U.S.-Canada border.